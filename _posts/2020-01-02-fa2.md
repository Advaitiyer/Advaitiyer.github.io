---
title: "Portfolio Sorting Strategy for 6000+ companies"
date: 2020-01-02T10:30:30-04:00
permalink: /bian/2020-01-02-fa/
categories:
  - Portfolio
tags:
  - Finance
  - R
  - CAPM
  - Hypothesis Testing
  - Portfolio Management
  - Return Differentials
  - Risk Management
  - Volatility Factor
---
In this project, we investigated portfolio sorting strategy. We then listed one or more hypothesis to test the additional contribution of a factor.

**Step 1:** Prepare data

The dataset consists of 3 datasets:

1. Case3Market.csv:
  - DATEyyyymmdd : Date formed as year month and day. For example, 3July2017 is entered as 20170703. Our sample spans from 19960104 to 20151231.
  - MarketEXRET: Daily market excess returns in percentage unit defined as Rm,t+1 − Rf,t. The excess returns on the market, value- weight returns of all CRSP firms incorporated in the US and listed on the NYSE, AMEX, or NASDAQ that have a CRSP share code of 10 or 11.
  - RF : The Tbill return is the simple daily rate (in percentage) that over the number of trading days in the month compounds to 1-month TBill rate from Ibbotson and Associates Inc.
  - VIX2 : VIX index squared in monthly percentage squared unit
  - RV: realized variance in monthly percentage squared unit
  - VRP : variance risk premium in monthly percentage squared unit
  - SKEW: risk neutral skewness 

2. ”Case3Port.csv”:
  - FIRMRET: Daily returns in percentage unit defined as Ri,t+1. Different columns show for different firms.

3. ”Case3FirmSECID.csv”:
  - SECID: Security ID assigned by Optionmetrics to each security or in-
dex.
  - PERMNO: PERMNO is a unique permanent security identification number assigned by CRSP to each security.
  - TICKER : Ticker Symbol is an alphabetic symbol assigned to each security by an exchange. Tickers can be reused over time.
  - COMNAM : CRSP allocates a 32 character name description field for all securities. Preference is given to the spellings and abbreviations provided in Standard & Poor’s CUSIP Directory. In cases where all name sources provide descriptions in excess of 32 characters, CRSP furnishes its own abbreviations.

*Data Source: CRSP, Fama French Data Library and CBOE website.*

```javascript
Market<-read.csv("Case3Market.csv", header = FALSE, sep=",")
Port<-read.csv("Case3Port.csv", header = FALSE, sep=",")
FirmSECID<-read.csv("Case3FirmSECID.csv", header = TRUE, sep=",")
```
**Step 2:** Organize and merge data

We put the data into a panel. Made sure that different rows represent different days and different columns are listing returns for different firms. We also wanted to make sure that the factors provided here share the same number of rows in the cross-sectional return panel. Lastly, for all the data about to be analyzed, made sure we know how they handle missing values. In our case, we used NaN.

```javascript
## Create a variable DATE of class "Date" 
DATE<-as.Date(as.character(Market$V1), "%Y%m%d")
## Measure the dimension of "Case3Port"
dim(Market)
dim(Port)
dim(FirmSECID)
## columns and rows of the Port data file 
ncol_Port<-ncol(Port) nrow_Port<-nrow(Port)
## Risk free rate and market excess return 
Market_EXERT<-Market$V2
Rf<-Market$V3
## identify companies 
SECID<-FirmSECID$secid 
PERMNO<-FirmSECID$permno 
TICKER<-as.character(FirmSECID$Ticker) 
COMNAM<-FirmSECID$Name
```

**Step 3:** Dropped firms with no observations

Deleted firms with no observations in the whole sample period.

```javascript
## calculate the number of Nan for each firm 
num_Nan<-rep(0, ncol_Port)
for(i in 1:ncol_Port){
  num_Nan[i]<-sum (ifelse(is.nan(Port[, i]), 1, 0))
  }

## Find the firms that have no observations in the whole sample period 
vec_DELETE<-which(num_Nan == nrow_Port)
## Delete the firms that have no observations in the whole sample period 
## TICKER[-c(i)] can return vector TICKER without ith element of TICKER,
## given i is a positive integer and SECID_Clean<-SECID[-c(vec_DELETE)] 
PERMNO_Clean<-PERMNO[-c(vec_DELETE)] 
TICKER_Clean<-TICKER[-c(vec_DELETE)] 
COMNAM_Clean<-COMNAM[-c(vec_DELETE)]

## By assigning the value of NULL, we delete the corresponding variable in the data.frame. 
Port[, vec_DELETE]<-NULL
## output the beginning and the ending date in our sample 
lg<-length(DATE)
DATE[1]
DATE[lg]

## The number of firms that are kept and dropped 
ncol_Port_Clean<-ncol(Port) 
num_Dropped<-ncol_Port-ncol_Port_Clean
## Calculate Firm excess returns 
Firm_RET<-Port-Rf
```
**Step 4:** Calculated numerical moments

For each firm, summarized the excess returns by computing the time-series mean, standard deviation, skewness, kurtosis, minimum, maximum and annualized sharpe ratio. Put the quantile ( 5, 25, 50, 75, 95) of these statistics in one table. Also included IBM in an additional column.

```javascript
library(e1071)
## descriptive statistics 
Firm_Mean<-apply(Firm_RET, 2, mean, na.rm=TRUE) 
Firm_Std<-apply(Firm_RET, 2, sd, na.rm=TRUE) 
Firm_Skew<-apply(Firm_RET, 2, skewness, na.rm=TRUE) 
Firm_Kurt<-apply(Firm_RET, 2, kurtosis, na.rm=TRUE) 
Firm_Min<-apply(Firm_RET, 2, min, na.rm=TRUE) 
Firm_Max<-apply(Firm_RET, 2, max, na.rm=TRUE) 
Firm_Sharpe<-Firm_Mean/Firm_Std*sqrt(252)

## Calculate descriptive statistics, such as mean, standard deviation, and Sharpe-ratio for IBM 
IBM<-Firm_RET[, which(SECID_Clean==106276)] 
IBM_Mean<-mean(IBM, na.rm = TRUE)
IBM_Std<-sd(IBM, na.rm = TRUE) 
IBM_Skew<-skewness(IBM, na.rm = TRUE) 
IBM_Kurt<-kurtosis(IBM, na.rm = TRUE) 
IBM_Min<-min(IBM, na.rm = TRUE) 
IBM_Max<-max(IBM, na.rm = TRUE) 
IBM_Sharpe<-IBM_Mean/IBM_Std*sqrt(252)

## Calculate Quantile for each descriptive statistics 
Quantile_Percent<-c(0.05, 0.25, 0.5, 0.75, 0.95) 
Mean_Quantile<-quantile(Firm_Mean, Quantile_Percent, na.rm=TRUE) 
Std_Quantile<-quantile(Firm_Std, Quantile_Percent, na.rm=TRUE) 
Skew_Quantile<-quantile(Firm_Skew, Quantile_Percent, na.rm=TRUE) 
Kurt_Quantile<-quantile(Firm_Kurt, Quantile_Percent, na.rm=TRUE) 
Min_Quantile<-quantile(Firm_Min, Quantile_Percent, na.rm=TRUE) 
Max_Quantile<-quantile(Firm_Max, Quantile_Percent, na.rm=TRUE) 
Sharpe_Quantile<-quantile(Firm_Sharpe, Quantile_Percent, na.rm=TRUE)

## Construct a table to present the results
Table_2_1<-matrix(data=NA,nrow = 7, ncol = 6)
Table_2_1[1,]<-c(IBM_Mean, Mean_Quantile)
Table_2_1[2,]<-c(IBM_Std,Std_Quantile)
Table_2_1[3,]<-c(IBM_Skew,Skew_Quantile)
Table_2_1[4,]<-c(IBM_Kurt,Kurt_Quantile)
Table_2_1[5,]<-c(IBM_Min,Min_Quantile)
Table_2_1[6,]<-c(IBM_Max,Max_Quantile) Table_2_1[7,]<-c(IBM_Sharpe,Sharpe_Quantile)
rownames(Table_2_1)<-c("Mean", "Std", "Skew", "Kurt", "Min", "Max", "Sharpe-Ratio" colnames(Table_2_1)<-c("IBM","Q5","Q25","Q50","Q75","Q95") as.table(round(Table_2_1,2))
```

Results:

| Moments | IBM | Q5 | Q25 | Q50 | Q75 | Q95 |
| ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| Mean | 0.06 | -0.02 | 0.08 | 0.13 | 0.22 | 0.45 |
| Std | 1.83 | 1.73 | 2.63 | 3.69 | 5.23 | 9.54 |
| Skew | 0.51 | -0.10 | 0.59 | 1.23 | 2.75 | 12.90 |
| Kurt | 7.89 | 3.01 | 7.60 | 13.86 | 33.93 | 326.88 |
| Min | -14.42 | -46.53 | -31.98 | -23.03 | -15.56 | -7.62 |
| Max | 14.05 | 10.87 | 22.31 | 36.67 | 67.06 | 213.45 |
| Sharpe-Ratio | 0.56 | -0.10 | 0.43 | 0.59 | 0.76 | 1.26 |
